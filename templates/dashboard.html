<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobHunter Dashboard</title>
    <link rel="stylesheet" href="/static/style.css?v=2.0">
</head>
<body>
    <div class="page">
        <div class="header">
            <div class="brand">JobHunter</div>
            <div class="nav">
                <a href="/">All Jobs</a>
                <a href="/applied">My Applications</a>
                <a href="/stats">Statistics</a>
            </div>
        </div>

        <section class="hero">
            <div class="hero-card">
                <div class="pill">Live board ¬∑ {{ stats.total_jobs }} tracked</div>
                <h1>Match, apply, and track without breaking flow.</h1>
                <p>Highest-scoring roles surface first. Mark applied, update status, and move on‚Äîno spreadsheets, no guesswork.</p>
                <div class="hero-actions">
                    <a class="btn btn-primary" href="#job-list">Jump to matches</a>
                    <a class="btn btn-ghost" href="/applied">Review applications</a>
                    <button class="btn btn-outline" id="runScrapeBtn">Run scrape now</button>
                </div>
            </div>
            <div class="hero-aside">
                <div>
                    <div class="label">Ready to apply</div>
                    <div class="stat-pill">{{ stats.applied }} sent ¬∑ {{ "%.1f"|format(stats.response_rate) }}% response</div>
                </div>
                <div>
                    <div class="label">Interviews in play</div>
                    <div class="stat-pill">{{ stats.interviews }} interviews ¬∑ {{ stats.offers }} offers</div>
                </div>
                <div>
                    <div class="label">New jobs today</div>
                    <div class="stat-pill">{{ stats.total_jobs - stats.applied }} still open</div>
                </div>
                <div>
                    <div class="label">Last scrape</div>
                    {% if last_scrape %}
                        <div class="stat-pill">
                            {{ last_scrape.timestamp.strftime('%b %d, %I:%M %p') }} ¬∑ {{ last_scrape.jobs_new or 0 }} new added ¬∑ {{ last_scrape.jobs_found or 0 }} scraped ¬∑ {{ "%.1fs"|format(last_scrape.duration or 0) }}
                        </div>
                    {% else %}
                        <div class="stat-pill">Not run yet</div>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="filters">
            <div class="filters-row">
                <div>
                    <div class="label">Search jobs</div>
                    <input id="searchFilter" class="input" type="text" placeholder="Search title, company, skills...">
                </div>
                <div>
                    <div class="label">Location filter</div>
                    <select id="locationFilter" class="select">
                        <option value="all">All locations</option>
                        <option value="remote">Remote only</option>
                        <option value="nyc">New York</option>
                        <option value="sf">San Francisco</option>
                        <option value="la">Los Angeles</option>
                        <option value="seattle">Seattle</option>
                        <option value="austin">Austin</option>
                        <option value="boston">Boston</option>
                    </select>
                </div>
                <div>
                    <div class="label">Source</div>
                    <select id="sourceFilter" class="select">
                        <option value="all">All sources</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="builtin">BuiltIn</option>
                        <option value="yc_jobs">Y Combinator</option>
                    </select>
                </div>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; margin-top: 8px;">
                <span class="subtle"><span id="visibleCount">{{ (top_matches|length + great_matches|length + good_matches|length) }}</span> new roles ready to review</span>
                <button id="resetFilters" class="btn btn-outline btn-small">Reset filters</button>
            </div>
        </section>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Jobs</h3>
                <div class="value">{{ stats.total_jobs }}</div>
            </div>
            <div class="stat-card">
                <h3>Applied</h3>
                <div class="value">{{ stats.applied }}</div>
            </div>
            <div class="stat-card">
                <h3>Interviews</h3>
                <div class="value">{{ stats.interviews }}</div>
            </div>
            <div class="stat-card">
                <h3>Offers</h3>
                <div class="value">{{ stats.offers }}</div>
            </div>
            <div class="stat-card">
                <h3>Response Rate</h3>
                <div class="value">{{ "%.1f"|format(stats.response_rate) }}%</div>
            </div>
        </div>

        <section class="panel" id="job-list">
            <!-- Top Priority Matches (70%+) -->
            {% if top_matches %}
            <div class="section-title">
                <div>
                    <h2>üî• Top Priority Matches</h2>
                    <div class="subtle">{{ top_matches|length }} exceptional matches ‚â•70% ‚Äî Apply immediately</div>
                </div>
                <div class="pill score-high">Auto-apply tier 1</div>
            </div>

            <div class="jobs-grid">
                {% for job in top_matches %}
                {% include 'job_card.html' %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Great Matches (60-69%) -->
            {% if great_matches %}
            <div class="section-title" style="margin-top: 48px;">
                <div>
                    <h2>‚≠ê Strong Matches</h2>
                    <div class="subtle">{{ great_matches|length }} great opportunities 60-69% ‚Äî Review and apply</div>
                </div>
                <div class="pill score-mid">Worth reviewing</div>
            </div>

            <div class="jobs-grid">
                {% for job in great_matches %}
                {% include 'job_card.html' %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Good Matches (50-59%) -->
            {% if good_matches %}
            <div class="section-title" style="margin-top: 48px;">
                <div>
                    <h2>üëç Good Matches</h2>
                    <div class="subtle">{{ good_matches|length }} solid options 50-59% ‚Äî Consider if aligned</div>
                </div>
                <div class="pill score-low">Consider</div>
            </div>

            <div class="jobs-grid">
                {% for job in good_matches %}
                {% include 'job_card.html' %}
                {% endfor %}
            </div>
            {% endif %}

            <div id="emptyState" class="empty-state" {% if top_matches or great_matches or good_matches %}style="display:none;"{% endif %}>
                No new jobs found above 50% yet. Check back after next scrape.
            </div>
        </section>
    </div>

    <!-- Mark Applied Modal -->
    <div id="applyModal" class="modal">
        <div class="modal-content">
            <h3>Mark as Applied</h3>
            <div class="form-group">
                <label>CV Used</label>
                <input type="text" id="cvVersion" placeholder="e.g., Cohere_ML_Engineer_Resume.pdf">
            </div>
            <div class="form-group">
                <label>Application Method</label>
                <select id="appMethod">
                    <option value="linkedin">LinkedIn</option>
                    <option value="company_site">Company Website</option>
                    <option value="email">Email</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-primary" onclick="submitApplied()">Submit</button>
                <button class="btn btn-outline" onclick="closeModal('applyModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <h3>Update Job Status</h3>
            <div class="form-group">
                <label>Status</label>
                <select id="newStatus">
                    <option value="applied">Applied</option>
                    <option value="phone_screen">Phone Screen</option>
                    <option value="interview">Interview</option>
                    <option value="offer">Offer</option>
                    <option value="rejected">Rejected</option>
                    <option value="withdrawn">Withdrawn</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="statusNotes" placeholder="Add any notes..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-primary" onclick="submitStatus()">Update</button>
                <button class="btn btn-outline" onclick="closeModal('statusModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Cover Letter Modal -->
    <div id="coverLetterModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>Cover Letter</h3>
            <div id="coverLetterContent" style="max-height: 500px; overflow-y: auto; background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin: 16px 0; line-height: 1.7; white-space: pre-wrap; font-family: 'Inter', sans-serif;">
                Loading...
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-primary" onclick="copyCoverLetter()">Copy to Clipboard</button>
                <button class="btn btn-outline" onclick="closeModal('coverLetterModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        console.log('Dashboard JavaScript loaded successfully');
        let currentJobId = null;
        let currentCompany = null;

        function markApplied(jobId, company) {
            console.log('markApplied called:', jobId, company);
            currentJobId = jobId;
            currentCompany = company;
            try {
                const cvInput = document.getElementById('cvVersion');
                console.log('cvVersion element:', cvInput);
                cvInput.value = `${company.replace(/\s+/g, '_')}_Resume.pdf`;
                console.log('Opening modal...');
                openModal('applyModal');
            } catch (error) {
                console.error('Error in markApplied:', error);
                alert('Error: ' + error.message);
            }
        }

        function updateStatus(jobId) {
            console.log('updateStatus called:', jobId);
            currentJobId = jobId;
            openModal('statusModal');
        }

        function openModal(modalId) {
            console.log('openModal called:', modalId);
            const modal = document.getElementById(modalId);
            console.log('Modal element:', modal);
            if (modal) {
                modal.classList.add('active');
                console.log('Modal should now be visible');
            } else {
                console.error('Modal not found:', modalId);
                alert('Modal not found: ' + modalId);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function submitApplied() {
            const cvVersion = document.getElementById('cvVersion').value;
            const method = document.getElementById('appMethod').value;
            
            try {
                const response = await fetch('/api/mark_applied', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        cv_version: cvVersion,
                        method: method
                    })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('‚úì Marked as applied!');
                    closeModal('applyModal');
                    setTimeout(() => location.reload(), 700);
                } else {
                    showToast('Error: ' + (result.error || 'Could not mark applied'));
                }
            } catch (err) {
                showToast('Network error when marking applied');
            }
        }

        async function submitStatus() {
            const status = document.getElementById('newStatus').value;
            const notes = document.getElementById('statusNotes').value;
            
            try {
                const response = await fetch('/api/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        status: status,
                        notes: notes
                    })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úì Updated to ${status}!`);
                    closeModal('statusModal');
                    setTimeout(() => location.reload(), 700);
                } else {
                    showToast('Error: ' + (result.error || 'Could not update status'));
                }
            } catch (err) {
                showToast('Network error when updating status');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2500);
        }

        // View cover letter
        let currentCoverLetter = '';
        async function viewCoverLetter(jobId, company, title) {
            console.log('Fetching cover letter for job', jobId);
            const contentDiv = document.getElementById('coverLetterContent');
            
            // Clear any existing content first
            contentDiv.innerHTML = '';
            contentDiv.textContent = 'Loading...';
            openModal('coverLetterModal');
            
            try {
                const response = await fetch(`/api/cover_letter/${jobId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentCoverLetter = result.cover_letter;
                    // Clear completely before setting new content
                    contentDiv.innerHTML = '';
                    contentDiv.textContent = result.cover_letter;
                    console.log('Cover letter loaded successfully');
                    console.log('Cover letter length:', result.cover_letter.length);
                    console.log('First 100 chars:', result.cover_letter.substring(0, 100));
                } else {
                    contentDiv.innerHTML = `<div style="color: var(--warning); text-align: center; padding: 40px;">
                        <p style="font-size: 18px; margin-bottom: 12px;">üìÑ No cover letter found</p>
                        <p style="color: var(--muted); font-size: 14px;">This job hasn't been generated yet. Run the application generator for <strong>${company}</strong> - ${title}</p>
                    </div>`;
                    currentCoverLetter = '';
                }
            } catch (err) {
                console.error('Error fetching cover letter:', err);
                contentDiv.innerHTML = `<div style="color: var(--danger); text-align: center; padding: 40px;">
                    <p>Error loading cover letter</p>
                    <p style="color: var(--muted); font-size: 14px; margin-top: 8px;">${err.message}</p>
                </div>`;
                currentCoverLetter = '';
            }
        }

        function copyCoverLetter() {
            if (!currentCoverLetter) {
                showToast('‚ö† No cover letter to copy');
                return;
            }
            
            console.log('Attempting to copy cover letter, length:', currentCoverLetter.length);
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentCoverLetter).then(() => {
                    showToast('‚úì Copied to clipboard!');
                    console.log('Successfully copied via clipboard API');
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    // Fallback to old method
                    fallbackCopy(currentCoverLetter);
                });
            } else {
                // Use fallback for older browsers
                fallbackCopy(currentCoverLetter);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('‚úì Copied to clipboard!');
                    console.log('Successfully copied via fallback method');
                } else {
                    showToast('‚ö† Could not copy to clipboard');
                    console.error('Fallback copy failed');
                }
            } catch (err) {
                showToast('‚ö† Could not copy to clipboard');
                console.error('Fallback copy error:', err);
            }
            
            document.body.removeChild(textArea);
        }

        // Run scrape now
        const runScrapeBtn = document.getElementById('runScrapeBtn');
        async function triggerScrape() {
            if (!runScrapeBtn) return;
            runScrapeBtn.disabled = true;
            runScrapeBtn.textContent = 'Running...';
            try {
                const res = await fetch('/api/run_scrape', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('Scrape started. Refresh in ~30s.');
                } else {
                    showToast(data.error || 'Scrape already running');
                }
            } catch (e) {
                showToast('Error starting scrape');
            } finally {
                runScrapeBtn.disabled = false;
                runScrapeBtn.textContent = 'Run scrape now';
            }
        }
        if (runScrapeBtn) {
            runScrapeBtn.addEventListener('click', triggerScrape);
        }

        // Filters
        const searchFilter = document.getElementById('searchFilter');
        const locationFilter = document.getElementById('locationFilter');
        const sourceFilter = document.getElementById('sourceFilter');
        const resetFilters = document.getElementById('resetFilters');
        const emptyState = document.getElementById('emptyState');

        function applyFilters() {
            const query = (searchFilter.value || '').toLowerCase();
            const location = locationFilter.value;
            const source = sourceFilter.value;
            let visible = 0;

            document.querySelectorAll('.job-card').forEach(card => {
                const text = card.dataset.text || '';
                const cardLocation = (card.querySelector('.job-meta .meta-item')?.textContent || '').toLowerCase();
                const cardSource = card.dataset.source || (card.querySelector('.job-meta .meta-item:nth-child(3)')?.textContent || '').toLowerCase();
                const isRemote = card.dataset.remote === 'true';

                const matchesQuery = !query || text.includes(query);
                const matchesLocation = location === 'all' || 
                                       (location === 'remote' && isRemote) ||
                                       cardLocation.includes(location.toLowerCase());
                const matchesSource = source === 'all' || cardSource.includes(source);

                const show = matchesQuery && matchesLocation && matchesSource;
                card.style.display = show ? 'block' : 'none';
                if (show) visible += 1;
            });

            document.getElementById('visibleCount').textContent = visible;
            
            // Show/hide section titles based on visible cards in each section
            document.querySelectorAll('.section-title').forEach(title => {
                const nextElement = title.nextElementSibling;
                if (nextElement && nextElement.classList.contains('jobs-grid')) {
                    const visibleInSection = Array.from(nextElement.querySelectorAll('.job-card'))
                        .filter(card => card.style.display !== 'none').length;
                    title.style.display = visibleInSection > 0 ? 'flex' : 'none';
                }
            });
            
            emptyState.style.display = visible ? 'none' : 'block';
        }

        searchFilter.addEventListener('input', applyFilters);
        locationFilter.addEventListener('change', applyFilters);
        sourceFilter.addEventListener('change', applyFilters);
        resetFilters.addEventListener('click', () => {
            searchFilter.value = '';
            locationFilter.value = 'all';
            sourceFilter.value = 'all';
            applyFilters();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Event delegation for mark applied buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.mark-applied-btn')) {
                const btn = e.target.closest('.mark-applied-btn');
                const jobId = parseInt(btn.dataset.jobId);
                const company = btn.dataset.company;
                markApplied(jobId, company);
            }
            
            if (e.target.closest('.update-status-btn')) {
                const btn = e.target.closest('.update-status-btn');
                const jobId = parseInt(btn.dataset.jobId);
                updateStatus(jobId);
            }
            
            if (e.target.closest('.view-cover-letter-btn')) {
                const btn = e.target.closest('.view-cover-letter-btn');
                const jobId = parseInt(btn.dataset.jobId);
                const company = btn.dataset.company;
                const title = btn.dataset.title;
                viewCoverLetter(jobId, company, title);
            }
        });

        window.onload = applyFilters;
    </script>
</body>
</html>
